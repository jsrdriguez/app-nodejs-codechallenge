version: "3.7"
services:
  api:
    image: api-gw:v1
    container_name: ${API_GATEWAY_NAME}
    build:
      context: ${API_GATEWAY_PATH}
    depends_on: [kafka, mongodb]
    volumes:
      - ${API_GATEWAY_PATH}/src:/app/src
    ports:
      - ${API_GATEWAY_PORT}:4000
    restart: on-failure
    env_file: ./.env
    environment:
      - KAFKA_BROKER=${KAFKA_BROKER}
      - KAFKA_CLIENT_ID=${KAFKA_CLIENT_ID}
      - DB_HOST=${DB_HOST}
      - DB_USER=${DB_USER}
      - DB_PASSWORD=${DB_PASSWORD}
      - DB_PORT=${DB_PORT}
      - DB_NAME=${DB_NAME}
      
  transaction:
    image: transaction-wk:v1
    container_name: ${TRANSACTION_WORKER_NAME}
    build:
      context: ${TRANSACTION_WORKER_PATH}
    depends_on: [kafka, mongodb]
    volumes:
      - ${TRANSACTION_WORKER_PATH}/src:/app/src
    restart: on-failure
    env_file: ./.env
    environment:
      - KAFKA_BROKER=${KAFKA_BROKER}
      - KAFKA_CLIENT_ID=${KAFKA_CLIENT_ID}
      - KAFKA_GROUP_ID=${KAFKA_GROUP_TRANS_ID}
      - DB_HOST=${DB_HOST}
      - DB_USER=${DB_USER}
      - DB_PASSWORD=${DB_PASSWORD}
      - DB_PORT=${DB_PORT}
      - DB_NAME=${DB_NAME}

  anti-fraud:
    image: anti-fraud-wk:v1
    container_name: ${API_FRAUD_WORKER_NAME}
    build:
      context: ${API_FRAUD_WORKER_PATH}
    depends_on: [kafka, mongodb]
    volumes:
      - ${API_FRAUD_WORKER_PATH}/src:/app/src
    restart: on-failure
    env_file: ./.env
    environment:
      - KAFKA_BROKER=${KAFKA_BROKER}
      - KAFKA_CLIENT_ID=${KAFKA_CLIENT_ID}
      - KAFKA_GROUP_ID=${KAFKA_GROUP_FRAUD_ID}
    
  mongodb:
    image: mongo
    restart: always
    environment:
      - MONGO_INITDB_ROOT_USERNAME=${DB_USER}
      - MONGO_INITDB_ROOT_PASSWORD=${DB_PASSWORD}
    ports:
      - 27018:27017
      
  zookeeper:
    image: confluentinc/cp-zookeeper:5.5.3
    environment:
      ZOOKEEPER_CLIENT_PORT: 2181

  kafka:
    restart: on-failure
    image: confluentinc/cp-enterprise-kafka:5.5.3
    depends_on: [zookeeper]
    environment:
      KAFKA_ZOOKEEPER_CONNECT: "zookeeper:2181"
      KAFKA_ADVERTISED_LISTENERS: PLAINTEXT://kafka:29092,PLAINTEXT_HOST://localhost:9092
      KAFKA_LISTENER_SECURITY_PROTOCOL_MAP: PLAINTEXT:PLAINTEXT,PLAINTEXT_HOST:PLAINTEXT
      KAFKA_BROKER_ID: 1
      KAFKA_OFFSETS_TOPIC_REPLICATION_FACTOR: 1
      KAFKA_JMX_PORT: 9991
    ports:
      - 9092:9092
